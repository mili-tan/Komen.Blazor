@page "/"
@using Nethereum.Signer
@inject IJSRuntime jsRuntime;
@inject IEthereumHostProvider ethereumHostProvider;
@inject NethereumAuthenticator  nethereumAuthenticator;

<h1>Hello, world!</h1>

@if (!hasMeta)
{
    <div class="alert alert-secondary mt-4" role="alert">
        <span class="oi oi-data-transfer-download mr-2" aria-hidden="true"></span>

        <span class="text-nowrap">
            如果您还没有 MetaMask，请先安装。 
            <a target="_blank" class="font-weight-bold" href="https://metamask.io/">获取</a>
        </span>
    </div>
}
else if(!isConnected)
{
    <div>
        <button type="button" class="btn btn-primary" @onclick="async () => await Connect()">连接 MetaMask</button>
    </div>
}
else
{
    <div>
        <button type="button" class="btn btn-primary" @onclick="async () => await Sign()">签名</button>
    </div>
}

@code
{
    bool hasMeta;
    bool isConnected;
    string account = string.Empty;

    protected override async Task OnAfterRenderAsync(bool firstTime)
    {
        if (firstTime)
        {
            ethereumHostProvider.SelectedAccountChanged += EthereumHostProviderOnSelectedAccountChanged;
            hasMeta = await ethereumHostProvider.CheckProviderAvailabilityAsync();
            isConnected = !string.IsNullOrWhiteSpace(ethereumHostProvider.SelectedAccount);
        }
    }

    private async Task EthereumHostProviderOnSelectedAccountChanged(string arg)
    {
        isConnected = !string.IsNullOrWhiteSpace(arg);
        account = arg;
        StateHasChanged();
    }

    async Task Connect()
    {
        await ethereumHostProvider.EnableProviderAsync();
    }

    async Task Sign()
    {
        var challenge = "Komen: Hello, World!";
        var signedMessage = await ethereumHostProvider.SignMessageAsync(challenge);

        Console.WriteLine("C:" + challenge);
        Console.WriteLine("S:" + signedMessage);

        new EthereumMessageSigner().EncodeUTF8AndEcRecover(challenge, signedMessage);
    }
}
